-- CREATE DATABASE
CREATE DATABASE librarydb;

CREATE USER libdbuser WITH ENCRYPTED PASSWORD 'libdbuser1';
GRANT ALL PRIVILEGES ON DATABASE librarydb TO libdbuser;


-- provide permission for the user
ALTER DEFAULT PRIVILEGES 
    FOR USER libdbuser1   
    IN SCHEMA public
    GRANT SELECT, INSERT, UPDATE, DELETE ON TABLES TO libdbuser1;

-- CREATE TABLE LIB_USER
CREATE TABLE LIB_USER
(
  USER_ID           BIGINT NOT NULL,
  USER_NAME         VARCHAR(36) NOT NULL,
  USER_ENCRYTED_PASSWORD VARCHAR(128) NOT NULL,
  ENABLED           INT NOT NULL 
) ;
--  
ALTER TABLE LIB_USER
  ADD CONSTRAINT LIB_USER_PK PRIMARY KEY (USER_ID);
 
ALTER TABLE LIB_USER
  ADD CONSTRAINT LIB_USER_UK UNIQUE (USER_NAME);
 
 
-- CREATE TABLE ROLE
CREATE TABLE LIB_ROLE
(
  ROLE_ID   BIGINT NOT NULL,
  ROLE_NAME VARCHAR(30) NOT NULL
) ;

ALTER TABLE LIB_ROLE
  ADD CONSTRAINT LIB_ROLE_PK PRIMARY KEY (ROLE_ID);
 
ALTER TABLE LIB_ROLE
  ADD CONSTRAINT LIB_ROLE_UK UNIQUE (ROLE_NAME);
 
-- CREATE TABLE USER ROLE
CREATE TABLE USER_ROLE
(
  ID      BIGINT NOT NULL,
  USER_ID BIGINT NOT NULL,
  ROLE_ID BIGINT NOT NULL
);

ALTER TABLE USER_ROLE
  ADD CONSTRAINT USER_ROLE_PK PRIMARY KEY (ID);
 
ALTER TABLE USER_ROLE
  ADD CONSTRAINT USER_ROLE_UK UNIQUE (USER_ID, ROLE_ID);
 
ALTER TABLE USER_ROLE
  ADD CONSTRAINT USER_ROLE_FK1 FOREIGN KEY (USER_ID)
  REFERENCES LIB_USER (USER_ID);
 
ALTER TABLE USER_ROLE
  ADD CONSTRAINT USER_ROLE_FK2 FOREIGN KEY (ROLE_ID)
  REFERENCES LIB_ROLE (ROLE_ID);
 
-- INSERT USERS
 
INSERT INTO LIB_USER (USER_ID, USER_NAME, USER_ENCRYTED_PASSWORD, ENABLED)
VALUES (1, 'admin1', '$2a$10$/4pgYQ7qHqSvC1o/lUmd2uFQIr6LOMdtoGezgjuxA3P8bvZbWDW3m', 1);
 
INSERT INTO LIB_USER (USER_ID, USER_NAME, USER_ENCRYTED_PASSWORD, ENABLED)
VALUES (2, 'student1', '$2a$10$jWugqWDNKJqb81y4tQAaF.VEUA1tmoqjNtl/Pv2dSlg/ONQr3Us4G', 1);

INSERT INTO LIB_USER (USER_ID, USER_NAME, USER_ENCRYTED_PASSWORD, ENABLED)
VALUES (3, 'student2', '$2a$10$.HWnrxxQVjwB.vBexpRGYO3ABpSwygjx48ibX25evtuUwGQ9cI3Ki', 1);

INSERT INTO LIB_USER (USER_ID, USER_NAME, USER_ENCRYTED_PASSWORD, ENABLED)
VALUES (4, 'testadmin1', '$2a$10$dzwKkgbCRWFOrZtMmnVa3uLHpDMmhoAFjemsNPw.UOPeY0AFRfkrq', 1);
 
--- INSERT ROLES
 
INSERT INTO LIB_ROLE (ROLE_ID, ROLE_NAME)
VALUES (1, 'ROLE_ADMIN');
 
INSERT INTO LIB_ROLE (ROLE_ID, ROLE_NAME)
VALUES (2, 'ROLE_SUPERVISOR');
 
 INSERT INTO LIB_ROLE (ROLE_ID, ROLE_NAME)
VALUES (3, 'ROLE_STUDENT');

--- ASSIGN ROLES
 
INSERT INTO USER_ROLE (ID, USER_ID, ROLE_ID)
VALUES (1, 1, 1);
 
INSERT INTO USER_ROLE (ID, USER_ID, ROLE_ID)
VALUES (2, 1, 2);
 
INSERT INTO USER_ROLE (ID, USER_ID, ROLE_ID)
VALUES (3, 2, 3);

INSERT INTO USER_ROLE (ID, USER_ID, ROLE_ID)
VALUES (4, 3, 3);


INSERT INTO USER_ROLE (ID, USER_ID, ROLE_ID)
VALUES (5, 4, 1);

INSERT INTO USER_ROLE (ID, USER_ID, ROLE_ID)
VALUES (6, 4, 2);

COMMIT;


CREATE TABLE LIB_BORROWER
(
  BOR_ID			BIGINT NOT NULL,
  USER_ID           BIGINT NOT NULL,
  BOOK_ID           BIGINT NOT NULL,
  ISSUED_BY         BIGINT NOT NULL,
  DATE_OF_ISSUE		TIMESTAMP NOT NULL,
  DATE_OF_RETURN 	TIMESTAMP NOT NULL
);

ALTER TABLE LIB_BORROWER
  ADD CONSTRAINT LIB_BORROWER_PK PRIMARY KEY (BOR_ID);
  
ALTER TABLE LIB_BORROWER
  ADD CONSTRAINT LIB_BORROWER_USER_FK1 FOREIGN KEY (USER_ID)
  REFERENCES LIB_USER (USER_ID);

ALTER TABLE LIB_BORROWER
  ADD CONSTRAINT LIB_BORROWER_BOOK_FK2 FOREIGN KEY (BOOK_ID)
  REFERENCES LIB_INVENTORY (BOOK_ID);


	
-- Books issued seed data

INSERT INTO LIB_BORROWER (BOR_ID, USER_ID, BOOK_ID, ISSUED_BY, DATE_OF_ISSUE, DATE_OF_RETURN )
VALUES (100,2,2,1,'2019-11-15 12:11:25-03' ,'2019-11-25 12:11:25-03');

INSERT INTO LIB_BORROWER (BOR_ID, USER_ID, BOOK_ID, ISSUED_BY, DATE_OF_ISSUE, DATE_OF_RETURN )
VALUES (101,2,4,1,'2019-11-10 12:11:25-03' ,'2019-11-20 12:11:25-03');

INSERT INTO LIB_BORROWER (BOR_ID, USER_ID, BOOK_ID, ISSUED_BY, DATE_OF_ISSUE, DATE_OF_RETURN )
VALUES (102,2,6,1,'2019-11-18 12:11:25-03' ,'2019-11-28 12:11:25-03');

INSERT INTO LIB_BORROWER (BOR_ID, USER_ID, BOOK_ID, ISSUED_BY, DATE_OF_ISSUE, DATE_OF_RETURN )
VALUES (103,2,8,1,'2019-11-10 12:11:25-03' ,'2019-11-20 12:11:25-03');

INSERT INTO LIB_BORROWER (BOR_ID, USER_ID, BOOK_ID, ISSUED_BY, DATE_OF_ISSUE, DATE_OF_RETURN )
VALUES (104,2,11,1,'2019-11-18 12:11:25-03' ,'2019-11-28 12:11:25-03');

INSERT INTO LIB_BORROWER (BOR_ID, USER_ID, BOOK_ID, ISSUED_BY, DATE_OF_ISSUE, DATE_OF_RETURN )
VALUES (105,2,12,1,'2019-11-18 12:11:25-03' ,'2019-11-28 12:11:25-03');

INSERT INTO LIB_BORROWER (BOR_ID, USER_ID, BOOK_ID, ISSUED_BY, DATE_OF_ISSUE, DATE_OF_RETURN )
VALUES (106,2,15,1,'2019-11-18 12:11:25-03' ,'2019-11-28 12:11:25-03');



UPDATE LIB_INVENTORY SET BOOK_AVAILABILITY = 0 WHERE BOOK_ID = 2 ;
UPDATE LIB_INVENTORY SET BOOK_AVAILABILITY = 0 WHERE BOOK_ID = 4 ;
UPDATE LIB_INVENTORY SET BOOK_AVAILABILITY = 0 WHERE BOOK_ID = 6 ;
UPDATE LIB_INVENTORY SET BOOK_AVAILABILITY = 0 WHERE BOOK_ID = 8 ;
UPDATE LIB_INVENTORY SET BOOK_AVAILABILITY = 0 WHERE BOOK_ID = 11 ;
UPDATE LIB_INVENTORY SET BOOK_AVAILABILITY = 0 WHERE BOOK_ID = 12 ;
UPDATE LIB_INVENTORY SET BOOK_AVAILABILITY = 0 WHERE BOOK_ID = 15 ;

commit;








